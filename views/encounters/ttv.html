<!DOCTYPE html>
<html>
  <head>
    <title>TTV</title>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="/public/touchscreentoolkit/lib/javascripts/touchScreenToolkit.js" defer="true"></script>
    <!-- <script type="text/javascript" src="/public/touchscreentoolkit/lib/javascripts/standard.js" defer="true"></script> -->
    <script type="text/javascript" src="/assets/js/jquery.min.js"></script>

    <script type="text/javascript" src="/assets/js/yes_no_ctrls.js"></script>
    <link rel="stylesheet" href="/assets/css/yes_no_ctrls.css" type="text/css">
    <script type="text/javascript" src="/assets/js/post_parameters.js"></script>
    <script type="text/javascript" src="/assets/js/generic_ajaxrequest.js"></script>
    <script type="text/javascript" src="/apps/ART/assets/js/arv_number.js"></script>
    <script type="text/javascript" src="/assets/js/moment.js"></script>

    <script>
      var apiProtocol = sessionStorage.apiProtocol;
      var apiURL = sessionStorage.apiURL;
      var apiPort = sessionStorage.apiPort;
      var patientID = sessionStorage.patientID;
      var programID = sessionStorage.programID;

      var tt_cancel_destination = "/views/patient_dashboard.html?patient_id=" + patientID;

      var YesNoConcepts = {};
      YesNoConcepts["Yes"] = 1065;
      YesNoConcepts["No"] = 1066;
      var ttv_order_id = "";

      function submitTreatmentEncounter() {
        var currentTime = moment().format(' HH:mm:ss');
        var encounter_datetime = moment(sessionStorage.sessionDate).format('YYYY-MM-DD'); 
        encounter_datetime += currentTime;
                        	
        var encounter = {
          encounter_type_name: 'TREATMENT',
          encounter_type_id:  25,
          patient_id: patientID,
          encounter_datetime: encounter_datetime
        }
        submitParameters(encounter, "/encounters", "postDrugOrders");
      }

      function postDrugOrders(encounter){
       var drug_orders_params = {encounter_id: encounter.encounter_id, 
          drug_orders: [
            {
              drug_inventory_id: 609,
              dose: 0.5,
              equivalent_daily_dose: 0.5,
              frequency: "Once a day (od)",
              start_date: sessionStorage.sessionDate,
              auto_expire_date: sessionStorage.sessionDate,
              instructions: "Once a day",
              units: "ml"
            }
          ]
        }
        
        submitParameters(drug_orders_params, "/drug_orders", "submitDispenseEncounter");
      }

      function submitDispenseEncounter(drugOrders){
        var currentTime = moment().format(' HH:mm:ss');
        var encounter_datetime = moment(sessionStorage.sessionDate).format('YYYY-MM-DD'); 
        encounter_datetime += currentTime;
        ttv_order_id = drugOrders[0].order_id;
                        	
        var encounter = {
          encounter_type_name: 'DISPENSE',
          encounter_type_id:  54,
          patient_id: patientID,
          encounter_datetime: encounter_datetime
        }
    
        submitParameters(encounter, "/encounters", "postTTVObs");
      }
      

      function postTTVObs(encounter){
        var obs = {
          encounter_id: encounter.encounter_id,
          observations: [
            { concept_id: 2834, order_id: ttv_order_id, value_numeric: 1 }
          ]
        }; 

        submitParameters(obs, "/observations", "nextPage")
      }

      function nextPage(obs){
        nextEncounter(sessionStorage.patientID, programID);
      }

      function addYesNo() {
        var tar = document.getElementById("inputFrame" + tstCurrentPage);
        var attr = 'TTV has been given today'
        buildYesNoUI('DISPENSING', attr, tar);
      }

      function submitFunction() {
        var nextButton = document.getElementById('nextButton');
        nextButton.innerHTML = '<span>Finish</span>';
        nextButton.setAttribute('onmousedown', 'submitTreatmentEncounter()');
      }

    </script>
  </head>
  <body id="mateme">
  <div id="container">
    <div id="content">
      <form>
        <input type="text" name="prescription"
          tt_onLoad="__$('keyboard').style.display = 'none';addYesNo();submitFunction();"
          tt_pageStyleClass= "NoControls" helpText="Prescription" optional = "true"/>
      </form>
   </div>
 </div>
</body>