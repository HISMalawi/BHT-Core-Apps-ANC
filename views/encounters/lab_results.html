<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <title>ANC - Lab Results</title>
    <script type="text/javascript" src="/public/touchscreentoolkit/lib/javascripts/touchScreenToolkit.js" defer="true"></script>
    <script type="text/javascript" src="/assets/js/jquery.min.js"></script>

    <script type="text/javascript" src="/assets/js/yes_no_ctrls.js"></script>
    <link rel="stylesheet" href="/assets/css/yes_no_ctrls.css" type="text/css"/>
    <script type="text/javascript" src="/assets/js/post_parameters.js"></script>
    <script type="text/javascript" src="/assets/js/generic_ajaxrequest.js"></script>
    <script type="text/javascript" src="/assets/js/moment.js"></script>
    <script type="text/javascript" src="/apps/ANC/assets/js/common.js"></script>

    <script type="text/javascript">
      tstUsername = "admin";
      var tstCurrentDate = moment(tstCurrentDate).format("YYYY-MM-DD");
      var patientID = sessionStorage.patientID;
      var programID = sessionStorage.programID;
      var tt_cancel_destination = "/views/patient_dashboard.html?patient_id=" + patientID;

      YesNoConcepts = {};
      YesNoConcepts["Yes"] = 1065;
      YesNoConcepts["No"] = 1066;

      var todayDate = new Date(tstCurrentDate);
      var originaltestDate = ""
          
      var alert_date = new Date(todayDate);
      alert_date.setDate(alert_date.getDate()- 90)

      // var alertDate = createDates(moment(alert_date).format("YYYY"), moment(alert_date).format("MM"), moment(alert_date).format("DD"));
      var patient_age = parseInt(sessionStorage.patientAge);
      var ageInMonths = patient_age * 12;

      var currentYear = moment(tstCurrentDate).format("YYYY");
      var currentMonth = moment(tstCurrentDate).format("MM");
      var selected_stage_conditions = {};
      var selected_stage_conditions_copy = {}
          
      var firstPositiveHivTestType = "UNKNOWN";
      var previous_hiv_test = false;

      var concept_map = {
        "positive": 703,
        "negative": 664,
        "unknown": 1064,
        "inconsistence": 9436,
        "trace" : 6698
      }

      /**
       * * For ANC
       */

      Object.defineProperty(Date.prototype, "format", {
         value: function (format) {
                 var date = this;
                 var result = "";

                 if (!format) {

                              format = ""

                 }

                  var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

                  var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September",
                              "October", "November", "December"];

                  if (format.match(/YYYY\-mm\-dd/)) {

                              result = date.getFullYear() + "-" + padZeros((parseInt(date.getMonth()) + 1), 2) + "-" + padZeros(date.getDate(), 2);

                  } else if (format.match(/mmm\/d\/YYYY/)) {

                              result = months[parseInt(date.getMonth())] + "/" + date.getDate() + "/" + date.getFullYear();

                  } else if (format.match(/d\smmmm,\sYYYY/)) {

                              result = date.getDate() + " " + monthNames[parseInt(date.getMonth())] + ", " + date.getFullYear();

                  } else {

                              result = date.getDate() + "/" + months[parseInt(date.getMonth())] + "/" + date.getFullYear();

                  }

                          return result;
                 }
      });
  function checkHIVTestDate(){
    if(__$("previous_test_status_from_before_currrent_facility_visit").value == "Negative in the last 3 months"){
      
      var hiv_test_date_str = __$("touchscreenInput" + tstCurrentPage).value.replace(/-/g, '/');

      var hiv_test_date     = new Date(hiv_test_date_str);
      var today             = new Date(tstCurrentDate);

      var weeks_ago = parseInt((today.getTime()- hiv_test_date.getTime())/ (1000 * 60 * 60 * 24 * 7));

      if (weeks_ago > 12){
        showMessage("Patient needs to be tested again");
        return true;
      }
      
    }
    return false;
  }

          
      function getSelectedLabTests(){
        var lab_tests = "";
        if($('available_test_results')){
          for(var o = 0; o < $('available_test_results').options.length; o++){
            if($('available_test_results').options[o].selected == true){
              lab_tests += $('available_test_results').options[o].value + " ";
            }
          }
        }
        return lab_tests;
      }

      function getSelectedUrineTests(){
        var urine_tests = "";
        if($('available_urine_tests')){
          for(var o = 0; o < $('available_urine_tests').options.length; o++){
            if($('available_urine_tests').options[o].selected == true){
              urine_tests += $('available_urine_tests').options[o].value + " ";
            }
          }
        }
        return urine_tests;
      }

      function removeHIVOption(){
        var lab_test_list = $('available_test_results');
        var hiv_option = $('hiv');
        var prev_hiv_test_res = ""
        
        if ($('prev_hiv_test_result')){
          prev_hiv_test_res = $('prev_hiv_test_result').value
        }

        try{
          if ($('9655_yes').attributes.class.nodeValue.match(/\ clicked/) || 
            prev_hiv_test_res === 'Positive'){

            lab_test_list.options[hiv_option.index] = null;
          }
        }catch(e){
          console.log(e);
        }
      }

      function addHIVOption(){
        try{
          var hiv_option = $('hiv');
          if (!hiv_option){
            new_hiv_option = new Option('HIV', 'hiv', false, false);
            $('available_test_results').options[0] = new_hiv_option;
            new_hiv_option.setAttribute('id', 'hiv');
          }
        }catch(e){
          console.log(e);
        }
      }

      function updatePreviousHIVTestDoneResponse(){
        if ($('9655_yes').attributes.class.nodeValue.match(/\ clicked/)){
          previous_hiv_test = true;
        }else{
          previous_hiv_test = false;
        }
      }
      function checkPreviousHIVTest(){
        return previous_hiv_test;
      }

      function addYesNoToLabTests() {
        var tar = document.getElementById("inputFrame" + tstCurrentPage);
        var attr = 'Pregnancy test done,3339#Previous HIV test done,9655'
        buildYesNoUI('Lab Results', attr, tar);
      }
      
      function submitLabResultsEncounter() {
        var currentTime = moment().format(' HH:mm:ss');
        var encounter_datetime = moment(sessionStorage.sessionDate).format('YYYY-MM-DD');
        encounter_datetime += currentTime;
        
        var encounter = {
          encounter_type_name: 'LAB RESULTS',
          encounter_type_id: 32,
          patient_id: patientID,
          encounter_datetime: encounter_datetime
        }
        
        submitParameters(encounter,"/encounters/", "postLabResultsObs");
      }

      function postLabResultsObs(encounter) {
        var obs = {
          encounter_id: encounter.encounter_id,
          observations: [
            { concept_id: 2473, value_coded: YesNoConcepts[yesNo_Hash['Lab Results']['Pregnancy test done']] },
            { concept_id: 9655, value_coded: YesNoConcepts[yesNo_Hash['Lab Results']['Previous HIV test done']] }
          ]
        };
      
        // Getting previous HIV test Results
        if (yesNo_Hash['Lab Results']['Previous HIV test done'] === "Yes"){
          var previous_hiv_test_result = $('prev_hiv_test_result').value;
          var prev_hiv_test_date = $('prev_hiv_test_date').value.split("-").reverse().join("-");

          obs.observations.push(
            {concept_id: 9656, value_coded: concept_map[previous_hiv_test_result] },
            {concept_id: 9657, value_datetime: prev_hiv_test_date }
          )
          
          //Previous hiv test results is positive
          if(previous_hiv_test_result === 'positive'){
            var on_art = $('on_art').value
            var arv_number = $('arv_number').value 

            obs.observations.push(
              {concept_id: 7010, value_coded: YesNoConcepts[on_art]}
            )

            if(on_art === 'Yes' && arv_number !== ''){
              // Save to Patient Identifier
              /** 
               * obs.observations.push(
               *   {concept_id: '', value_text: arv_number}
               * )
               */
            }
          }

        }

        if($('hiv_status').value !== ""){
          obs.observations.push(
            {concept_id: 3753, value_coded: concept_map[$('hiv_status').value]}
          );

          if ($('hiv_status').value === "positive") {
            var on_art = $('on_art').value
            var arv_number = $('arv_number').value 

            obs.observations.push(
              {concept_id: 7010, value_coded: YesNoConcepts[on_art]}
            );

            if(on_art === 'Yes' && arv_number !== ''){
              // Save to Patient Identifier
              /** 
               * obs.observations.push(
               *   {concept_id: '', value_text: arv_number}
               * )
               */
            }
          }
        }

        if ($('hb').value !== "") {
          obs.observations.push(
            {concept_id: 7982, value_numeric: parseInt($('hb').value) }
          );
        }
        
        if ($('syphilis').value !== "") {
          obs.observations.push(
            {concept_id: 7984, value_coded: concept_map[$('syphilis').value] }
          );
        }
        
        if ($('malaria').value !== "") {
          obs.observations.push(
            {concept_id: 9227, value_coded: concept_map[$('malaria').value] }
          );
        }
        
        if ($('blood_group').value !== "") {
          obs.observations.push(
            {concept_id: 300, value_text: $('blood_group').value }
          );
        }

        if ($('protein').value !== "") {
          obs.observations.push(
            {concept_id: 6447, value_text: $('protein').value }
          );
        }
        
        if ($('glucose').value !== "") {
          obs.observations.push(
            {concept_id: 887, value_text: $('glucose').value }
          );
        }
        
        if ($('wbc').value !== "") {
          obs.observations.push(
            {concept_id: 678, value_numeric: parseInt($('wbc').value) }
          );
        }
        
        if ($('rbc').value !== "") {
          obs.observations.push(
            {concept_id: 679, value_numeric: parseInt($('rbc').value) }
          );
        }
        
        if ($('nitrate').value !== "") {
          obs.observations.push(
            {concept_id: 9618, value_coded: concept_map[$('nitrate').value] }
          );
        }


        submitParameters(obs,"/observations/", "nextPage");
      }

      function nextPage(){
        nextEncounter(patientID, programID);
      }

      function setAbsoluteMaxYear() {
        var y = document.getElementById('touchscreenInput' + tstCurrentPage);
        var maxYear = moment(sessionStorage.sessionDate).subtract(1, "day").format("DD-MM-YYYY");
        y.setAttribute('max', maxYear);
     }

     function checkMaxAndValue() {

        var yearInput = document.getElementById('touchscreenInput' + tstCurrentPage);
        var yearInputValue = yearInput.value;
        var maxValue = yearInput.getAttribute('max');

        var inputDate = yearInputValue.split("-").reverse().join("-");
        var maxDate = maxValue.split("-").reverse().join("-");

          if(inputDate > maxDate && inputDate !== 'Invalid date') {
            showMessage('Value bigger than maximum '+maxDate);
            return;
          }else {
            gotoNextPage();
          }

     }

     function submitButton(){
        var nextButton =  document.getElementById('nextButton');
        nextButton.onmousedown = function(){
          checkMaxAndValue();
        }
      
     }

      function changeSubmitFunction(){
        var nextButton =  document.getElementById('nextButton');
        nextButton.onmousedown = function(){
          var selected_lab_values = getSelectedLabTests().split(" ").filter(Boolean);
          var selected_urine_values = getSelectedUrineTests().split(" ").filter(Boolean);

          if (selected_lab_values.length > 0){
            var field_name = $("touchscreenInput"+tstCurrentPage).name
            if (selected_lab_values[selected_lab_values.length - 1] === field_name || 
              selected_urine_values[selected_urine_values.length - 1] === field_name ){
              if (selected_lab_values[selected_lab_values.length - 1] === "urine"){
                if (selected_urine_values.length > 0){
                  if (selected_urine_values[selected_urine_values.length - 1] === field_name) {
                    submitLabResultsEncounter();
                  }else{
                    gotoNextPage();
                  }
                }else{
                  submitLabResultsEncounter();
                }
              }else{
                submitLabResultsEncounter();
              }
            }else{
              gotoNextPage();
            }
          }else{
            submitLabResultsEncounter();
          }
        }
      }

      function hideCategory() {
        document.getElementById('category').style = 'display: none;'
      }

    </script>
    
  </head>

  <body id="mateme">
    <div id="container">
      <div id="content">
        <form>
          <input type="text" name="lab-results"
            tt_onLoad="__$('keyboard').style.display = 'none'; 
              addYesNoToLabTests(); addHIVOption();"
            optional="true" tt_onUnload="removeHIVOption();
              updatePreviousHIVTestDoneResponse();"
            tt_pageStyleClass= "NoControls" helpText="Lab Results" />

          <select tt_onLoad="" condition="checkPreviousHIVTest();" 
            allowFreeText="false" id="prev_hiv_test_result" name="prev_hiv_test_result" 
            helpText="Previous HIV test results" tt_onUnLoad=""
            tt_pageStyleClass="NoKeyboard">
              
              <option value=''></option>
              <option value="negative">Negative</option>
              <option value="positive">Positive</option>
              <option value="inconclusive">Inconclusive</option>
              <option value="unknown">Unknown</option>
              
          </select>

          <input tt_onLoad="setAbsoluteMaxYear();submitButton();
            __$('today').style.display='none';" tt_onUnLoad="" condition="$('prev_hiv_test_result').value !== '';" 
            field_type="date" helpText="Previous HIV test date"
            id="prev_hiv_test_date" name="previous hiv test date"
            tt_pageStyleClass="Date DatesOnly" type="text"/>

          <select tt_onLoad="showCategory2('Available Lab Test Results');" 
            allowFreeText="false" condition="$('prev_hiv_test_result').value === 'positive'" 
            helpText="Patient on ART" id="on_art" name="on art" 
            tt_pageStyleClass="NoKeyboard">
            
              <option value=''></option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
          
          </select>
                    
          <input tt_onLoad ="showCategory2('Available Lab Test Results');__$('Unknown').style.display='inline';"
            condition="$('on_art').value === 'Yes';" field_type="text" helpText="ARV Number" 
            id="arv_number" name="arv_number" tt_pageStyleClass="" 
            type="text" />

          <select condition="" multiple="multiple" 
            helpText="Available Lab Tests" optional="true" 
            id="available_test_results" name="available_test_results" 
            tt_onLoad="showCategory2('Lab results');changeSubmitFunction();" 
            tt_pageStyleClass="NoKeyboard">

              <option value="hiv_status" id="hiv">HIV</option>
              <option value="hb">HB</option>
              <option value="syphilis">Syphilis</option>
              <option value="malaria">Malaria</option>
              <option value="blood_group">Blood Group</option>
              <option value="urine">Urine</option>
          
          </select>

          <select tt_onLoad="showCategory2('Available Lab Test Results');
              changeSubmitFunction();" allowFreeText="false" 
            condition="getSelectedLabTests().match(/hiv/)" 
            helpText="HIV Test Result" id="hiv_status" 
            name="hiv_status" tt_pageStyleClass="NoKeyboard">
            
              <option value=''></option>
              <option value="negative">Negative</option>
              <option value="positive">Positive</option>
              <option value="inconclusive">Inconclusive</option>
              <!-- option value="Unknown">Unknown< /option-->
          
          </select>

          <select tt_onLoad="showCategory2('Available Lab Test Results');" 
            allowFreeText="false" condition="$('hiv_status').value === 'Positive'" 
            helpText="Patient on ART" id="on_art" name="on_art" 
            tt_pageStyleClass="NoKeyboard">
            
              <option value=''></option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
          
          </select>
                    
          <input tt_onLoad ="showCategory2('Available Lab Test Results');__$('Unknown').style.display='inline';"
            condition="$('on_art').value === 'Yes';" field_type="text" helpText="ARV Number" 
            id="arv_number" name="arv_number" tt_pageStyleClass="" 
            type="text" />

          <input condition="getSelectedLabTests().match(/hb/);" field_type="number" 
            helpText="HB Test Result (g/dl)" id="hb" name="hb" 
            tt_onLoad="showCategory2('Available Lab Test Results');
              changeSubmitFunction();" 
            tt_onUnLoad="" type="text" max="16" min="2"
            validationCode="" tt_pageStyleClass="Numeric NumbersOnlyWithDecimal" 
            validationMessage="" />

          <select tt_onLoad="showCategory2('Available Lab Test Results');
              changeSubmitFunction" allowFreeText="false" 
            condition="getSelectedLabTests().match(/syphilis/)" 
            helpText="Syphilis Test Result" 
            id="syphilis" name="syphilis" tt_pageStyleClass="NoKeyboard">
             
              <option value=''></option>
              <option value="negative">Negative</option>
              <option value="positive">Positive</option>
              
          </select>
          
          <select tt_onLoad="showCategory2('Available Lab Test Results');
              changeSubmitFunction();" 
            allowFreeText="false" condition="getSelectedLabTests().match(/malaria/)" 
            helpText="Malaria Test Result" 
            id="malaria" name="malaria" tt_pageStyleClass="NoKeyboard">
              
              <option value=''></option>
              <option value="negative">Negative</option>
              <option value="positive">Positive</option>
              
          </select>

          <select tt_onLoad="showCategory2('Available Lab Test Results');
              changeSubmitFunction();" allowFreeText="false" 
            condition="getSelectedLabTests().match(/blood_group/);" 
            helpText="Blood Group Test Result" id="blood_group" 
            name="blood_group" tt_pageStyleClass="NoKeyboard">
            
              <option value=''></option>
              <option value="A+">A+</option>
              <option value="A-">A-</option>
              <option value="B+">B+</option>
              <option value="B-">B-</option>
              <option value="AB+">AB+</option>
              <option value="AB-">AB-</option>
              <option value="O+">O+</option>
              <option value="O-">O-</option>
              
          </select>
          
          <select condition="getSelectedLabTests().match(/urine/);" multiple="multiple" 
            helpText="Available Urine Tests Results" optional="true" 
            id="available_urine_tests" name="urine" 
            tt_onLoad="showCategory2(Available Lab Test Results);
              changeSubmitFunction();" 
            tt_pageStyleClass="NoKeyboard">

              <option value=""></option>
              <option value="protein">Urine protein</option>
              <option value="glucose">Glucose</option>
              <option value="wbc">WBC</option>
              <option value="rbc">RBC</option>
              <option value="nitrate">Nitrate</option>
                    
          </select>
          
          <select allowFreeText="false" condition="getSelectedUrineTests().match(/protein/)" 
            helpText="Urine Protein Test Result" 
            id="protein" name="protein" 
            tt_onLoad="showCategory2('Available Urine Test Results');" 
            tt_onUnLoad="">

              <option value=""></option>
              <option value="negative">Negative</option>
              <option value="(+)">(+)</option>
              <option value="+">+</option>
              <option value="++">++</option>
              <option value="+++">+++</option>
              <option value="++++">++++</option>
          
          </select>
                    
          <select condition="getSelectedUrineTests().match(/glucose/)" 
            helpText="Glucose Test Result (mg/dl)" 
            id="glucose" name="glucose" 
            tt_onLoad="showCategory2('Available Urine Test Results');
              changeSubmitFunction();" 
            tt_onUnLoad="" validationMessage="">

              <option value=""></option>
              <option value="normal">Normal</option>
              <option value="+">+</option>
              <option value="++">++</option>
              <option value="+++">+++</option>
                    
          </select>
          
          <input condition="getSelectedUrineTests().match(/wbc/);" 
            field_type="number" min="0" max="1000000"
            helpText="White Blood Cells Test Result (cmm)" 
            id="wbc" name="wbc" 
            tt_onLoad="showCategory2('Available Urine Test Results');
              changeSubmitFunction();" 
            tt_onUnload="" type="text" 
            tt_pageStyleClass="numeric NumbersOnlyWithDecimal" />

          <input condition="getSelectedUrineTests().match(/rbc/)" 
            field_type="number" min="0" max="1000000" 
            helpText="Red Blood Cells Test Result (cmm)" 
            id="rbc" name="rbc" 
            tt_onLoad="showCategory2('Available Urine Test Results');
              changeSubmitFunction();" 
            tt_onUnload="" type="text" 
            tt_pageStyleClass="numeric NumbersOnlyWithDecimal" />

          <select tt_onLoad="showCategory2('Available Urine Test Results');
              changeSubmitFunction();" allowFreeText="false" 
            condition="getSelectedUrineTests().match(/nitrate/);" 
            helpText="Nitrate Test Result" id="nitrate" 
            name="nitrate" tt_onUnload="" tt_pageStyleClass="NoKeyboard">
            
              <option value=''></option>
              <option value="negative">Negative</option>
              <option value="trace">Trace</option>
              <option value="positive">Positive</option>
               
          </select>

          <input name="commit" type="submit" value="Finish" onmousedown="submitLabResultsEncounter();"/>

        </form>
      </div>
    </div>
  </body>
</html>